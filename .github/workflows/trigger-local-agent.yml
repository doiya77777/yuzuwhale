name: Trigger Local Agent

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  trigger:
    runs-on: [self-hosted, yuzu-agent]
    # Required when secrets are configured as Environment secrets in GitHub.
    # Ensure the environment name matches the one you configured (case-sensitive).
    environment: Production
    steps:
      - name: Debug secrets presence (safe)
        env:
          WEBHOOK_URL: ${{ secrets.LOCAL_AGENT_WEBHOOK_URL }}
          WEBHOOK_SECRET: ${{ secrets.LOCAL_AGENT_WEBHOOK_SECRET }}
        run: |
          echo "WEBHOOK_URL set? $([ -n "$WEBHOOK_URL" ] && echo yes || echo no)"
          echo "WEBHOOK_SECRET set? $([ -n "$WEBHOOK_SECRET" ] && echo yes || echo no)"
          echo "WEBHOOK_URL length: $(printf %s "$WEBHOOK_URL" | wc -c | tr -d ' ')"
          echo "WEBHOOK_SECRET length: $(printf %s "$WEBHOOK_SECRET" | wc -c | tr -d ' ')"
      - name: Call local webhook
        env:
          WEBHOOK_URL: ${{ secrets.LOCAL_AGENT_WEBHOOK_URL }}
          WEBHOOK_SECRET: ${{ secrets.LOCAL_AGENT_WEBHOOK_SECRET }}
        run: |
          set -euo pipefail
          if [ -z "$WEBHOOK_URL" ] || [ -z "$WEBHOOK_SECRET" ]; then
            echo "Missing webhook secrets" && exit 1
          fi
          response="$(curl -sS -X POST "$WEBHOOK_URL" \
            -H "Authorization: Bearer $WEBHOOK_SECRET" \
            -H "Content-Type: application/json" \
            -d '{"task":"daily_news"}' \
            -w '\n__HTTP_STATUS__:%{http_code}\n')"
          status="$(printf '%s' "$response" | sed -n 's/.*__HTTP_STATUS__:\\([0-9][0-9][0-9]\\).*/\\1/p')"
          body="$(printf '%s' "$response" | sed 's/__HTTP_STATUS__:[0-9][0-9][0-9]//g')"
          printf "%s" "$body" > webhook-response.json
          echo "$body"

          python3 - <<'PY'
          import json
          from pathlib import Path

          raw = Path("webhook-response.json").read_text(encoding="utf-8").strip()
          try:
            data = json.loads(raw or "{}")
          except Exception as e:
            raise SystemExit(f"Webhook did not return JSON. body={raw[:2000]}")

          if data.get("ok") is not True:
            raise SystemExit(f"Webhook ok!=true. data={data}")
          PY

      - name: Notify Feishu (optional)
        env:
          FEISHU_BOT_WEBHOOK_URL: ${{ secrets.FEISHU_BOT_WEBHOOK_URL }}
        run: |
          set -euo pipefail
          if [ -z "$FEISHU_BOT_WEBHOOK_URL" ]; then
            echo "FEISHU_BOT_WEBHOOK_URL not set; skipping."
            exit 0
          fi

          python3 - <<'PY'
          import json
          from pathlib import Path

          data = json.loads(Path("webhook-response.json").read_text(encoding="utf-8") or "{}")
          ok = data.get("ok")
          date = data.get("date") or ""
          doc = data.get("feishu_doc_url") or ""
          site = data.get("site_news_url") or ""

          lines = []
          lines.append(f"Yuzu Daily 运行结果：{'✅ OK' if ok else '❌ FAILED'}")
          if date:
            lines.append(f"日期：{date}")
          if doc:
            lines.append(f"飞书文档：{doc}")
          else:
            lines.append("飞书文档：未生成（检查 FEISHU_APP_ID/FEISHU_APP_SECRET/FEISHU_FOLDER_TOKEN）")
          if site:
            lines.append(f"站点链接：{site}")
          print("\n".join(lines))
          Path("feishu-message.txt").write_text("\n".join(lines), encoding="utf-8")
          PY

          msg="$(cat feishu-message.txt)"
          python3 - <<'PY'
          import json
          from pathlib import Path

          msg = Path("feishu-message.txt").read_text(encoding="utf-8")
          payload = {"msg_type": "text", "content": {"text": msg}}
          Path("feishu-payload.json").write_text(json.dumps(payload, ensure_ascii=False), encoding="utf-8")
          PY

          curl -sS -X POST "$FEISHU_BOT_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @feishu-payload.json

      - name: Upload run artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: yuzu-daily-run
          path: |
            webhook-response.json
            feishu-message.txt
            feishu-payload.json
